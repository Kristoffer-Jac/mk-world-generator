<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mario Kart World – Slumpgenerator (v15)</title>
<style>
  :root {
    --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --muted: #64748b;
    --ring: rgba(0,0,0,.08); --brand: #0ea5e9; --nintendo:#E70009;
  }
  * { box-sizing: border-box; }
  html, body { margin:0; height:100%; }
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: linear-gradient(135deg,#eef2ff,#ecfeff,#f0fdfa); color: var(--text); }
  .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
  .screen { display:none; }
  .screen.active { display:block; }
  .grid { display:grid; gap:16px; }
  .card { background: var(--card); border: 1px solid #e5e7eb; border-radius: 14px; box-shadow: 0 1px 2px var(--ring); }
  .pad { padding: 16px; }
  button.btn, .btn { appearance:none; border:1px solid #e5e7eb; background:#fff; padding:12px 14px; border-radius:12px; cursor:pointer; box-shadow: 0 1px 1px var(--ring); font-weight:600; }
  button.btn:hover { box-shadow: 0 1px 4px var(--ring); }
  button.btn.primary { background: #0ea5e9; border-color:#0ea5e9; color:#fff; }
  button.btn:disabled { opacity:.6; cursor:not-allowed; }
  textarea { width:100%; height:120px; padding:10px; border:1px solid #e5e7eb; border-radius:10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; }
  .dropzone { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 14px; text-align: center; transition: .15s; background: #fff; }
  .dropzone.active { border-color: #38bdf8; background: #f0f9ff; }
  .lists { display:grid; gap:16px; }
  .list-item { display:flex; align-items:center; gap:10px; padding:8px; border-radius:10px; border:1px solid #e5e7eb; background:#ffffffd0; }
  .avatar { width:44px; height:44px; border-radius:9999px; overflow:hidden; background: #e2e8f0; display:grid; place-items:center; font-weight:800; }
  .avatar.small { width: 36px; height: 36px; }
  .scroll { max-height: 320px; overflow:auto; }

  /* Generator */
  .gen-wrap { display:grid; gap:18px; padding: 18px; }
  .chosen-bar { display:flex; flex-wrap:wrap; gap:16px; justify-content:center; }
  .chosen-card { display:flex; flex-direction:column; align-items:center; gap:8px; }
  .chosen-item { width:200px; height:200px; border-radius:50%; overflow:hidden;
    border: 6px solid #fff; box-shadow: 0 12px 40px rgba(2,6,23,.12), inset 0 0 0 2px rgba(0,0,0,.06);
    background: linear-gradient(135deg,#fde68a,#fdba74);
    display:grid; place-items:center; font-weight:900; font-size:42px; letter-spacing:-.02em; }
  .chosen-name { font-size:16px; font-weight:700; text-align:center; line-height:1.2; max-width: 220px; color:#fff; }
  .current-wrap { display:grid; place-items:center; gap:18px; padding: 18px; }
  .current-icon { width: 200px; height: 200px; border-radius: 9999px; overflow:hidden; border: 6px solid #fff; box-shadow: 0 12px 40px rgba(2,6,23,.12), inset 0 0 0 2px rgba(0,0,0,.06); background: linear-gradient(135deg,#bbf7d0,#a7f3d0); display:grid; place-items:center; font-size:48px; font-weight:900; letter-spacing:-.02em; }
  .current-name { font-size: 36px; font-weight: 900; letter-spacing: -.02em; text-align:center; color:#fff; }
  .gen-buttons { display:flex; gap:12px; justify-content:center; }
  .gen-card { background: var(--nintendo); color:#fff; border-radius:16px; border:none; box-shadow: 0 8px 30px rgba(0,0,0,.15); position:relative; }
  .gen-card .btn { background:#fff; color:var(--nintendo); border:2px solid #fff; }
  .gen-card .btn:hover { background:#f9fafb; }
  .gen-card .current-icon, .gen-card .chosen-item { border-color:#fff; }

  /* Text-style link for settings (top-right in generator) */
  .link-top{ position:absolute; top:12px; right:14px; background:transparent; border:none; color:#fff; font-weight:700; cursor:pointer; padding:6px 8px; }
  .link-top:hover{ text-decoration:underline; }

  /* Placeholder logo */
  .placeholder-wrap { display:grid; place-items:center; }
  .placeholder-wrap img { max-width: 520px; width: 90%; height:auto; display:block; }
</style>
</head>
<body>
  <div class="container">

    <!-- Generator (default view) -->
    <section id="screen-generator" class="screen active">
      <div class="gen-card pad gen-wrap">
        <button id="toSettings" class="link-top" aria-label="Inställningar">Inställningar</button>
        <!-- Big current result -->
        <div class="current-wrap">
          <div id="genIcon" class="current-icon">–</div>
          <div id="genName" class="current-name">–</div>
          <!-- Placeholder logo (visible when no track yet) -->
          <div id="placeholder" class="placeholder-wrap" style="display:none;">
            <img src="Mario_Kart_World_logo.png" alt="Mario Kart World logo" />
          </div>
        </div>

        <!-- Only two buttons -->
        <div class="gen-buttons">
          <button id="btnGenRoll" class="btn primary">SLUMPA</button>
          <button id="btnGenReset" class="btn">NOLLSTÄLL</button>
        </div>

        <!-- Chosen history bar (icons) BELOW buttons -->
        <div id="chosenBar" class="chosen-bar"></div>
      </div>
    </section>

    <!-- Settings -->
    <section id="screen-settings" class="screen">
      <div style="text-align:right; margin-bottom:8px;">
        <button id="toGenerator" class="btn" style="background:transparent;border:none;color:#0ea5e9;font-weight:700;cursor:pointer;">Till slumpgeneratorn</button>
      </div>
      <div class="grid" style="grid-template-columns: 1fr 330px;">
        <section class="card pad">
          <div class="grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
            <label class="muted" title="Om avmarkerad tillåts dubbletter">
              <input id="chkExclude" type="checkbox" checked />
              <span>Uteslut banor som redan valts</span>
            </label>
            <button id="btnLoadOfficial" class="btn">Ladda officiella MK World‑banor</button>
          </div>

          <div class="pad"></div>

          <div class="card pad">
            <div class="title">Nu vald bana</div>
            <div style="display:flex; align-items:center; gap:14px;">
              <div class="avatar" id="currentAvatar">–</div>
              <div id="currentName" style="font-size: 24px; font-weight: 800; letter-spacing: -0.02em;">–</div>
            </div>
            <div class="pad" style="padding-left:0;">
              <div class="grid" style="grid-template-columns: auto auto; gap: 8px;">
                <button id="btnReset" class="btn">Nollställ omgång</button>
                <button id="btnUndo" class="btn">Ångra senaste</button>
              </div>
            </div>
          </div>

          <div class="pad"></div>

          <div class="card pad">
            <div class="title">Importera banor</div>
            <div class="muted" style="margin-bottom:8px;">Klistra in alla banor (en per rad) och klicka "Ladda banor".</div>
            <textarea id="txtTracks" placeholder="Exempel:
Mario Bros. Circuit
Crown City
..."></textarea>
            <div class="pad" style="padding-left:0;">
              <div class="grid" style="grid-template-columns: auto auto; gap: 8px;">
                <button id="btnLoadFromText" class="btn">Ladda banor</button>
                <button id="btnExportToText" class="btn">Exportera nuvarande → rutan</button>
              </div>
            </div>
          </div>
        </section>

        <aside class="lists">
          <section class="card pad">
            <div class="title">Valda banor</div>
            <div class="muted" style="margin-bottom:8px;">Senaste överst</div>
            <div id="chosenList"></div>
          </section>

          <section class="card pad">
            <div class="title">Ladda ikon‑mappning (JSON) <span id="iconStatus" style="margin-left:8px;padding:4px 8px;border-radius:9999px;background:#eef2ff;color:#1e3a8a;font-size:11px;font-weight:700;">Källa: —</span></div>
            <div class="muted" style="margin-bottom:8px;">Dra in din <code>.json</code> eller välj fil; alternativt klistra in JSON i rutan.</div>

            <div id="drop" class="dropzone">Släpp din <strong>mk_world_icons.json</strong> här</div>
            <div class="pad" style="padding-left:0; display:flex; gap:8px; align-items:center;">
              <input id="fileJson" type="file" accept="application/json,.json" />
              <input id="fileJsonAuto" type="file" accept="application/json,.json" style="display:none" />
              <button id="btnClearIcons" class="btn">Rensa ikoner</button>
            </div>

            <textarea id="txtIcons" class="font-mono" placeholder='Exempel:
{
  "Mario Bros. Circuit": "/images/tracks/mario-bros-circuit.png",
  "Crown City": "data:image/png;base64,..."
}'></textarea>
            <div class="pad" style="padding-left:0;">
              <button id="btnLoadIconsText" class="btn">Ladda från text</button>
              <button id="btnReloadDefaultIcons" class="btn">Återställ till standard</button>
            </div>
          </section>

          <section class="card pad">
            <div class="title">Återstående banor</div>
            <div id="availableList" class="scroll"></div>
          </section>
        </aside>
      </div>
    </section>

  </div>

<script>
// —— Data ——
const DEFAULT_TRACKS = [
  "Mario Bros. Circuit","Crown City","Whistlestop Summit","DK Spaceport",
  "Desert Hills","Shy Guy Bazaar","Wario Stadium","Airship Fortress",
  "DK Pass","Starview Peak","Sky-High Sundae","Wario Shipyard",
  "Koopa Troopa Beach","Faraway Oasis","Peach Stadium",
  "Peach Beach","Salty Salty Speedway","Dino Dino Jungle","Great ? Block Ruins",
  "Cheep Cheep Falls","Dandelion Depths","Boo Cinema","Dry Bones Burnout",
  "Moo Moo Meadows","Choco Mountain","Toad's Factory","Bowser's Castle",
  "Acorn Heights","Mario Circuit","Rainbow Road"
];

let allTracks = [...DEFAULT_TRACKS];
let available = [...allTracks];
let chosen = [];
let current = null;
let icons = {}; // namn -> url/dataURL
let excludeDuplicates = true;

// —— Helpers ——
const $ = (q) => document.querySelector(q);
function initials(name) { return name.split(" ").map(s => s[0]).join("").slice(0,3).toUpperCase(); }
function showScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  const el = document.getElementById(id);
  if (el) el.classList.add("active");
  renderSettings(); renderGenerator();
}
function renderSettings() {
  const chk = $("#chkExclude"); if (chk) chk.checked = excludeDuplicates;

  const avatar = $("#currentAvatar"); const nameEl = $("#currentName");
  if (avatar && nameEl) {
    if (current) {
      nameEl.textContent = current;
      const src = icons[current];
      if (src) { avatar.innerHTML = ""; const img = new Image(); img.src = src; img.alt = current; img.style.width="100%"; img.style.height="100%"; img.style.objectFit="cover"; avatar.appendChild(img); }
      else { avatar.textContent = initials(current); avatar.style.background = "linear-gradient(135deg,#bbf7d0,#a7f3d0)"; }
    } else { nameEl.textContent = "–"; avatar.textContent = "–"; avatar.style.background = "linear-gradient(135deg,#bbf7d0,#a7f3d0)"; }
  }

  const chosenBox = $("#chosenList");
  if (chosenBox) {
    if (!chosen.length) { chosenBox.innerHTML = '<div class="muted">– Inga val ännu –</div>'; }
    else {
      const items = chosen.map(t => {
        const src = icons[t];
        const av = src ? '<img src="'+src+'" style="width:100%;height:100%;object-fit:cover;" />' : initials(t);
        return '<div class="list-item"><div class="avatar small">'+av+'</div><span style="font-size:14px;font-weight:600;">'+t+'</span></div>';
      }).join("");
      chosenBox.innerHTML = items;
    }
  }

  const availBox = $("#availableList");
  if (availBox) {
    if (!excludeDuplicates) { availBox.innerHTML = '<div class="muted">Dubbletter tillåts – listan visas inte i detta läge.</div>'; }
    else {
      if (!available.length) { availBox.innerHTML = '<div class="muted">– Inga återstående –</div>'; }
      else {
        const items = available.map(t => {
          const src = icons[t];
          const av = src ? '<img src="'+src+'" style="width:100%;height:100%;object-fit:cover;" />' : initials(t);
          return '<div class="list-item"><div class="avatar small">'+av+'</div><span style="font-size:14px;font-weight:600;">'+t+'</span></div>';
        }).join("");
        availBox.innerHTML = items;
      }
    }
  }
}
function renderGenerator() {
  const bar = $("#chosenBar");
  if (bar) {
    if (!chosen.length) bar.innerHTML = "";
    else {
      bar.innerHTML = "";
      chosen.forEach(name => {
        const card = document.createElement("div"); card.className = "chosen-card";
        const el = document.createElement("div"); el.className = "chosen-item";
        const src = icons[name];
        if (src) { const img = new Image(); img.src = src; img.alt = name; img.style.width="100%"; img.style.height="100%"; img.style.objectFit="cover"; el.appendChild(img); }
        else { el.textContent = initials(name); }
        el.title = name;
        const cap = document.createElement("div"); cap.className = "chosen-name"; cap.textContent = name;
        card.appendChild(el); card.appendChild(cap); bar.appendChild(card);
      });
    }
  }

  const nameEl = $("#genName");
  const iconEl = $("#genIcon");
  const placeholder = $("#placeholder");
  if (nameEl && iconEl && placeholder) {
    if (current) {
      if (placeholder) placeholder.style.display = "none";
      nameEl.style.display = "block";
      iconEl.style.display = "grid";
      nameEl.textContent = current;
      const src = icons[current];
      if (src) {
        iconEl.innerHTML = "";
        const img = new Image(); img.src = src; img.alt = current;
        img.style.width = "100%"; img.style.height = "100%"; img.style.objectFit = "cover";
        iconEl.appendChild(img);
      } else {
        iconEl.textContent = initials(current);
        iconEl.style.background = "linear-gradient(135deg,#bbf7d0,#a7f3d0)";
      }
    } else {
      if (placeholder) placeholder.style.display = "grid";
      nameEl.style.display = "none";
      iconEl.style.display = "none";
    }
  }

  const btnGenRoll = $("#btnGenRoll");
  if (btnGenRoll) btnGenRoll.disabled = excludeDuplicates ? available.length === 0 : allTracks.length === 0;
}

// —— Actions ——
function rollOnce() {
  const pool = excludeDuplicates ? available : allTracks;
  if (!pool.length) return;
  const idx = Math.floor(Math.random() * pool.length);
  const picked = pool[idx];
  current = picked;
  if (excludeDuplicates) { available.splice(idx,1); }
  chosen.unshift(picked);
  renderSettings(); renderGenerator();
}
function resetAll() {
  available = [...allTracks]; chosen = []; current = null;
  renderSettings(); renderGenerator();
}
function undoLast() {
  if (!excludeDuplicates) return;
  if (!chosen.length) return;
  const last = chosen.shift();
  if (last != null) available.unshift(last);
  current = chosen[0] || null;
  renderSettings(); renderGenerator();
}
function importTracksFromText() {
  const txt = $("#txtTracks").value;
  const lines = txt.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  if (!lines.length) return;
  allTracks = lines; available = [...allTracks]; chosen = []; current = null;
  renderSettings(); renderGenerator();
}
function exportTracksToText() { $("#txtTracks").value = allTracks.join("\n"); }
function loadOfficialTracks() {
  allTracks = [...DEFAULT_TRACKS]; available = [...allTracks]; chosen = []; current = null;
  $("#txtTracks").value = DEFAULT_TRACKS.join("\n");
  renderSettings(); renderGenerator();
}


// —— Default icons autoload ——
async function loadDefaultIcons(silent=true) {
  try {
    // Support override via ?icons=URL
    const sp = new URLSearchParams(location.search);
    const custom = sp.get("icons");
    const url = custom || (new URL("mk_world_icons.json", location.href)).toString();
    const resp = await fetch(url, { cache: "no-store" });
    if (!resp.ok) throw new Error("HTTP " + resp.status);
    const json = await resp.json();
    if (json && typeof json === "object") {
      icons = json;
      if (!silent) alert("Standard-ikoner laddade.");
      renderSettings(); renderGenerator();
      return true;
    }
  } catch (e) {
    if (!silent) alert("Kunde inte ladda standard-ikoner.");
  }
  return false;
}


let iconSource = "—"; // "standard", "url", "uppladdad", "text", "tom"

function setIconSource(srcLabel) {
  iconSource = srcLabel;
  const el = document.getElementById("iconStatus");
  if (el) el.textContent = "Källa: " + srcLabel;
}

// —— Default icons autoload ——
async function loadDefaultIcons(silent=true) {
  try {
    const sp = new URLSearchParams(location.search);
    const custom = sp.get("icons");
    if (custom) {
      const resp = await fetch(custom, { cache: "no-store" });
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const json = await resp.json();
      if (json && typeof json === "object") {
        icons = json; setIconSource("URL");
        if (!silent) alert("Ikoner laddade från URL-parametern.");
        renderSettings(); renderGenerator();
        return true;
      }
    } else {
      // Try same-folder default if not using file://
      if (location.protocol !== "file:") {
        const url = new URL("mk_world_icons.json", location.href).toString();
        const resp = await fetch(url, { cache: "no-store" });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const json = await resp.json();
        if (json && typeof json === "object") {
          icons = json; setIconSource("standard (mk_world_icons.json)");
          if (!silent) alert("Standard-ikoner laddade.");
          renderSettings(); renderGenerator();
          return true;
        }
      } else {
        // file:// fallback – prompt the user to pick mk_world_icons.json from disk
        const auto = document.getElementById("fileJsonAuto");
        if (auto) {
          if (!silent) alert("Välj din mk_world_icons.json (lokal fil) – webbläsaren blockerar automatisk läsning i file://-läge.");
          auto.onchange = (e) => {
            const f = auto.files && auto.files[0];
            if (!f) return;
            const reader = new FileReader();
            reader.onload = () => {
              try {
                const json = JSON.parse(reader.result);
                if (json && typeof json === "object") {
                  icons = json; setIconSource("lokal fil (standard)");
                  renderSettings(); renderGenerator();
                } else { alert("JSON saknar giltig struktur."); }
              } catch (err) { alert("Ogiltig JSON."); }
            };
            reader.readAsText(f);
          };
          auto.click();
        }
      }
    }
  } catch (e) {
    if (!silent) alert("Kunde inte ladda standard-ikoner: " + e.message);
    return false;
  }
  return false;
}

// —— Icons JSON ——
function handleIconsText(text) {
  try {
    const obj = JSON.parse(text);
    if (obj && typeof obj === "object") { icons = obj; setIconSource("text"); renderSettings(); renderGenerator(); }
    else alert("JSON saknar giltig struktur.");
  } catch (e) { alert("Ogiltig JSON. Kontrollera formatet."); }
}

// —— Wiring ——
document.addEventListener("DOMContentLoaded", () => {
  // Default view: generator
  setIconSource("—");
  // Försök autoladda standard-ikoner från mk_world_icons.json (eller ?icons=URL)
  loadDefaultIcons(true);
  showScreen("screen-generator");

  // Nav
  document.getElementById("toSettings").addEventListener("click", () => showScreen("screen-settings"));
  document.getElementById("toGenerator").addEventListener("click", () => showScreen("screen-generator"));

  // Generator controls
  document.getElementById("btnGenRoll").addEventListener("click", rollOnce);
  document.getElementById("btnGenReset").addEventListener("click", resetAll);
  document.addEventListener("keydown", (e) => {
    if (e.code === "Space" && document.getElementById("screen-generator").classList.contains("active")) {
      e.preventDefault(); rollOnce();
    }
  });

  // Settings controls
  document.getElementById("chkExclude").addEventListener("change", (e) => { excludeDuplicates = e.target.checked; renderSettings(); renderGenerator(); });
  document.getElementById("btnReset").addEventListener("click", resetAll);
  document.getElementById("btnUndo").addEventListener("click", undoLast);
  document.getElementById("btnLoadFromText").addEventListener("click", importTracksFromText);
  document.getElementById("btnExportToText").addEventListener("click", exportTracksToText);
  document.getElementById("btnLoadOfficial").addEventListener("click", loadOfficialTracks);

  // Icons: drag & drop
  const drop = document.getElementById("drop");
  drop.addEventListener("dragover", (e) => { e.preventDefault(); drop.classList.add("active"); });
  drop.addEventListener("dragleave", (e) => { e.preventDefault(); drop.classList.remove("active"); });
  drop.addEventListener("drop", (e) => {
    e.preventDefault(); drop.classList.remove("active");
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = () => { setIconSource("uppladdad fil"); handleIconsText(typeof reader.result === "string" ? reader.result : ""); };
    reader.readAsText(f);
  });
  // Icons: file select
  document.getElementById("fileJson").addEventListener("change", (e) => {
    const f = e.target.files && e.target.files[0]; if (!f) return;
    const reader = new FileReader(); reader.onload = () => { setIconSource("uppladdad fil"); handleIconsText(typeof reader.result === "string" ? reader.result : ""); }; reader.readAsText(f);
  });
  // Icons: textarea
  document.getElementById("btnLoadIconsText").addEventListener("click", () => { setIconSource("text"); handleIconsText(document.getElementById("txtIcons").value); });
  document.getElementById("btnClearIcons").addEventListener("click", () => { icons = {}; setIconSource("—"); renderSettings(); renderGenerator(); });
  document.getElementById("btnReloadDefaultIcons").addEventListener("click", () => { loadDefaultIcons(false); });
  document.getElementById("btnReloadDefaultIcons").addEventListener("click", () => { loadDefaultIcons(false); });

  // First render (will show placeholder)
  renderSettings(); renderGenerator();
});
</script>
</body>
</html>
